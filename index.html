<!DOCTYPE html>
<html>
  <head>
    <title>Farm Map System</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
    />

    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
      // =======================
      // Classes
      // =======================
      class Farm {
        constructor(id, name, polygon, sensors = [], motors = []) {
          this.id = id;
          this.name = name;
          this.polygon = polygon;
          this.sensors = sensors;
          this.motors = motors;
        }
      }

      class Sensor {
        constructor(id, type, marker) {
          this.id = id;
          this.type = type;
          this.marker = marker;
        }
      }

      class Motor {
        constructor(id, marker) {
          this.id = id;
          this.marker = marker;
        }
      }

      // Arrays to store farms
      let farms = [];

      // =======================
      // Map Initialization
      // =======================
      const map = L.map("map", { preferCanvas: true }).setView(
        [40.4093, 49.8671],
        13
      );

      // Base Tiles (OpenStreetMap)
      const osm = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "Â© OpenStreetMap",
        }
      ).addTo(map);

      // =======================
      // Feature Groups
      // =======================
      const farmLayer = new L.FeatureGroup().addTo(map); // Polygons
      const markerLayer = new L.FeatureGroup().addTo(map); // Sensors/Motors

      // =======================
      // Leaflet Draw
      // =======================
      L.drawLocal.draw.toolbar.buttons.polygon = "Draw a farm area";
      L.drawLocal.draw.toolbar.buttons.marker = "Place a sensor or motor";
      const drawControl = new L.Control.Draw({
        draw: {
          polygon: { allowIntersection: false, showArea: true, color: "green" },
          polyline: false,
          rectangle: false,
          circle: false,
          marker: true,
        },
        edit: { featureGroup: farmLayer },
      });
      map.addControl(drawControl);

      // =======================
      // User Location
      // =======================
      let userMarker = null;
      function locateUser() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;
              map.setView([lat, lng], 16);

              if (!userMarker) {
                userMarker = L.marker([lat, lng])
                  .addTo(markerLayer)
                  .bindPopup("You are here!")
                  .openPopup();
              } else {
                userMarker.setLatLng([lat, lng]);
              }
            },
            (err) => alert("Cannot get location: " + err.message)
          );
        } else {
          alert("Geolocation not supported");
        }
      }

      // Optional: add a button to trigger location
      L.control.custom = function (opts) {
        const control = L.control({ position: opts.position });
        control.onAdd = function () {
          const btn = L.DomUtil.create("button", "locate-btn");
          btn.innerHTML = "My Location";
          btn.style.background = "white";
          btn.style.padding = "5px";
          btn.style.cursor = "pointer";
          btn.onclick = locateUser;
          return btn;
        };
        return control;
      };
      L.control.custom({ position: "topright" }).addTo(map);

      // =======================
      // Handle Drawn Layers
      // =======================
      map.on(L.Draw.Event.CREATED, function (e) {
        const type = e.layerType;
        const layer = e.layer;

        if (type === "polygon") {
          // Create farm object
          const farmId = farms.length + 1;
          const farm = new Farm(farmId, "Farm " + farmId, layer);
          farms.push(farm);
          farmLayer.addLayer(layer);
        } else if (type === "marker") {
          // Ask user if it's a sensor or motor
          const choice = prompt(
            "Place Sensor (s) or Motor (m)? Enter s/m"
          ).toLowerCase();
          if (choice === "s") {
            const sensorId = prompt("Enter Sensor ID");
            const sensorType = prompt("Enter Sensor Type");
            const sensor = new Sensor(sensorId, sensorType, layer);
            markerLayer.addLayer(layer);
            farms[farms.length - 1].sensors.push(sensor);
            layer
              .bindPopup(`Sensor: ${sensorType}, ID: ${sensorId}`)
              .openPopup();
          } else if (choice === "m") {
            const motorId = prompt("Enter Motor ID");
            const motor = new Motor(motorId, layer);
            markerLayer.addLayer(layer);
            farms[farms.length - 1].motors.push(motor);
            layer.bindPopup(`Motor ID: ${motorId}`).openPopup();
          }
        }
      });
    </script>
  </body>
</html>
